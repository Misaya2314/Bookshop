<!-- 顶部导航栏 -->
<t-navbar title="订单管理">
  <view slot="left" class="navbar-left" bindtap="goBack">
    <t-icon name="chevron-left" size="44rpx" />
  </view>
</t-navbar>

<!-- 订单状态标签 -->
<view class="order-tabs">
  <t-tabs value="{{currentTab}}" bind:change="onTabChange">
    <t-tab-panel 
      wx:for="{{tabs}}" 
      wx:key="value"
      label="{{item.labelWithCount}}" 
      value="{{item.value}}"
    />
  </t-tabs>
</view>

<!-- 加载状态 -->
<view class="loading-container" wx:if="{{loading}}">
  <t-loading theme="spinner" size="40rpx" />
  <text class="loading-text">加载中...</text>
</view>

<!-- 订单列表 -->
<scroll-view 
  scroll-y 
  class="orders-container" 
  wx:if="{{!loading}}" 
  refresher-enabled="{{true}}" 
  bind:refresherrefresh="onRefresh" 
  refresher-triggered="{{refreshing}}"
>
  <view class="order-list">
    <!-- 订单项 -->
    <view 
      class="order-item" 
      wx:for="{{orders}}" 
      wx:key="_id"
      bindtap="viewOrderDetail"
      data-id="{{item._id}}"
    >
      <!-- 订单头部 -->
      <view class="order-header">
        <view class="buyer-info">
          <t-icon name="user" size="32rpx" color="#3b82f6" />
          <text class="buyer-name">{{item.buyerName || '买家'}}</text>
        </view>
        <view class="order-status {{item.statusClass}}">
          {{item.statusText}}
        </view>
      </view>

      <!-- 商品列表 -->
      <view class="order-products">
        <view 
          class="product-item" 
          wx:for="{{item.products}}" 
          wx:key="_id"
          wx:for-item="product"
        >
          <view class="product-image">
            <image 
              wx:if="{{product.images && product.images.length > 0}}"
              src="{{product.images[0]}}" 
              class="book-image" 
              mode="aspectFill"
            />
            <text wx:else class="book-emoji">{{product.icon || '📚'}}</text>
          </view>
          <view class="product-info">
            <text class="product-title">{{product.title}}</text>
            <text class="product-desc">{{product.description}}</text>
            <view class="product-footer">
              <text class="product-price">¥{{product.price}}</text>
              <text class="product-quantity">x{{product.quantity}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 订单信息 -->
      <view class="order-info">
        <view class="order-detail">
          <text class="order-time">{{item.createTime}}</text>
          <text class="order-address">{{item.deliveryAddress}}</text>
        </view>
        <text class="order-total">共{{item.totalQuantity}}件商品 合计: ¥{{item.totalPrice}}</text>
      </view>

      <!-- 订单操作 -->
      <view class="order-actions">
        <!-- 待发货状态 -->
        <block wx:if="{{item.status === 'paid'}}">
          <t-button 
            size="small" 
            variant="outline" 
            catchtap="contactBuyer"
            data-id="{{item._id}}"
          >
            联系买家
          </t-button>
          <t-button 
            size="small" 
            theme="primary" 
            catchtap="shipOrder"
            data-id="{{item._id}}"
            style="margin-left: 16rpx;"
          >
            立即发货
          </t-button>
        </block>
        
        <!-- 已发货状态 -->
        <block wx:if="{{item.status === 'shipping'}}">
          <t-button 
            size="small" 
            variant="outline" 
            catchtap="contactBuyer"
            data-id="{{item._id}}"
          >
            联系买家
          </t-button>
        </block>
        
        <!-- 已完成状态 -->
        <block wx:if="{{item.status === 'completed'}}">
          <t-button 
            size="small" 
            variant="outline" 
            catchtap="contactBuyer"
            data-id="{{item._id}}"
          >
            联系买家
          </t-button>
        </block>
        
        <!-- 其他状态显示查看详情 -->
        <block wx:if="{{item.status !== 'paid' && item.status !== 'shipping' && item.status !== 'completed'}}">
          <t-button 
            size="small" 
            variant="outline"
            catchtap="viewOrderDetail"
            data-id="{{item._id}}"
          >
            查看详情
          </t-button>
        </block>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-orders" wx:if="{{orders.length === 0}}">
    <view class="empty-icon">📋</view>
    <text class="empty-text">暂无{{currentTabLabel}}订单</text>
    <text class="empty-desc">等待买家下单吧</text>
  </view>
</scroll-view>
