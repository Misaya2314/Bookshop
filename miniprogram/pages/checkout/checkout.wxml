<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<t-navbar title="ç¡®è®¤è®¢å•" />

<view class="checkout-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="spinner" size="40rpx" />
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <scroll-view scroll-y class="checkout-content" wx:if="{{!loading}}">
    <!-- æ”¶è´§ä¿¡æ¯ -->
    <view class="address-section">
      <view class="section-title">
        <t-icon name="location" size="32rpx" color="#3b82f6" />
        <text>æ”¶è´§ä¿¡æ¯</text>
      </view>
      
      <!-- æ”¶è´§äººå§“åè¾“å…¥ -->
      <view class="input-row">
        <t-input
          label="æ”¶è´§äººå§“å"
          value="{{recipientName}}"
          placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å"
          bind:change="onRecipientNameChange"
          required
        />
      </view>
      
      <!-- æ”¶è´§åœ°å€é€‰æ‹© -->
      <view class="address-card" bindtap="selectAddress">
        <view wx:if="{{deliveryAddress}}" class="address-info">
          <view class="address-main">
            <text class="address-label">æ”¶è´§åœ°å€ï¼š</text>
            <text class="address-detail">{{deliveryAddress}}</text>
          </view>
          <view class="contact-info">
            <text class="address-phone">{{userInfo.phone || 'è¯·å®Œå–„æ‰‹æœºå·'}}</text>
          </view>
        </view>
        <view wx:else class="no-address">
          <t-icon name="location" size="48rpx" color="#ccc" />
          <text class="no-address-text">è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
        </view>
        <t-icon name="chevron-right" size="32rpx" color="#999" />
      </view>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="products-section">
      <view class="section-title">
        <t-icon name="shop" size="32rpx" color="#3b82f6" />
        <text>å•†å“ä¿¡æ¯</text>
      </view>
      
      <!-- æŒ‰å•†å®¶åˆ†ç»„æ˜¾ç¤ºå•†å“ -->
      <view 
        class="merchant-group" 
        wx:for="{{merchants}}" 
        wx:key="merchantId"
        wx:for-item="merchant"
      >
        <!-- å•†å®¶ä¿¡æ¯ -->
        <view class="merchant-header">
          <t-icon name="shop" size="28rpx" color="#3b82f6" />
          <text class="merchant-name">{{merchant.merchantName}}</text>
        </view>
        
        <!-- å•†å“åˆ—è¡¨ -->
        <view class="product-list">
          <view 
            class="product-item" 
            wx:for="{{merchant.items}}" 
            wx:key="bookId"
            wx:for-item="item"
          >
            <view class="product-image">
              <t-image 
                wx:if="{{item.images && item.images.length > 0 && item.images[0].length > 2}}"
                src="{{item.images[0]}}" 
                mode="aspectFill"
                width="120rpx"
                height="120rpx"
                loading="lazy"
                error-icon="book"
              />
              <text wx:else class="book-emoji">{{item.images && item.images[0] ? item.images[0] : 'ğŸ“š'}}</text>
            </view>
            <view class="product-info">
              <text class="product-title">{{item.title}}</text>
              <view class="product-footer">
                <text class="product-price">Â¥{{item.price}}</text>
                <text class="product-quantity">x{{item.quantity}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- å•†å®¶å°è®¡ -->
        <view class="merchant-total">
          <text>å°è®¡: Â¥{{merchant.totalPrice}}</text>
        </view>
      </view>
    </view>

    <!-- é…é€ä¿¡æ¯ -->
    <view class="delivery-section">
      <view class="section-title">
        <t-icon name="delivery" size="32rpx" color="#3b82f6" />
        <text>é…é€ä¿¡æ¯</text>
      </view>
      <t-cell-group>
        <t-cell title="é…é€æ–¹å¼" note="æ ¡å†…é…é€" />
        <t-cell title="é…é€æ—¶é—´" note="1-2ä¸ªå·¥ä½œæ—¥" />
        <t-cell title="è¿è´¹" note="å…è¿è´¹" rightIcon="none" />
      </t-cell-group>
    </view>

    <!-- ä¼˜æƒ ä¿¡æ¯ -->
    <view class="coupon-section">
      <view class="section-title">
        <t-icon name="discount" size="32rpx" color="#3b82f6" />
        <text>ä¼˜æƒ ä¿¡æ¯</text>
      </view>
      
      <!-- æŒ‰å•†å®¶åˆ†ç»„æ˜¾ç¤ºä¼˜æƒ åˆ¸è¾“å…¥ -->
      <view 
        class="merchant-coupon-group" 
        wx:for="{{merchants}}" 
        wx:key="merchantId"
        wx:for-item="merchant"
      >
        <view class="merchant-coupon-header">
          <text class="merchant-name">{{merchant.merchantName}}</text>
        </view>
        
        <view class="coupon-input-card">
          <view class="coupon-input-row">
            <t-input 
              value="{{merchant.couponCode}}"
              placeholder="è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç "
              bind:change="onCouponCodeChange"
              data-merchant-id="{{merchant.merchantId}}"
              style="flex: 1;"
            />
            <t-button 
              size="small" 
              theme="{{merchant.couponCode ? 'primary' : 'default'}}"
              bind:tap="applyCoupon"
              data-merchant-id="{{merchant.merchantId}}"
              loading="{{merchant.validatingCoupon}}"
            >
              {{merchant.couponCode ? 'åº”ç”¨' : 'ä½¿ç”¨'}}
            </t-button>
          </view>
          
          <!-- ä¼˜æƒ åˆ¸éªŒè¯ç»“æœ -->
          <view class="coupon-result" wx:if="{{merchant.couponInfo}}">
            <view class="coupon-success">
              <t-icon name="check-circle-filled" size="32rpx" color="#10b981" />
              <text class="coupon-text">{{merchant.couponInfo.description || 'ä¼˜æƒ åˆ¸å¯ç”¨'}}</text>
              <text class="coupon-discount">{{merchant.discountText}}</text>
              <t-icon 
                name="close" 
                size="24rpx" 
                color="#999" 
                bind:tap="removeCoupon"
                data-merchant-id="{{merchant.merchantId}}"
              />
            </view>
          </view>
          
          <view class="coupon-error" wx:if="{{merchant.couponError}}">
            <t-icon name="close-circle-filled" size="32rpx" color="#ef4444" />
            <text class="error-text">{{merchant.couponError}}</text>
          </view>
        </view>
      </view>
    </view>



    <!-- è´¹ç”¨æ˜ç»† -->
    <view class="cost-section">
      <view class="section-title">
        <t-icon name="money" size="32rpx" color="#3b82f6" />
        <text>è´¹ç”¨æ˜ç»†</text>
      </view>
      <view class="cost-list">
        <view class="cost-item">
          <text class="cost-label">å•†å“æ€»ä»·</text>
          <text class="cost-value">Â¥{{originalTotalPrice}}</text>
        </view>
        <view class="cost-item">
          <text class="cost-label">é…é€è´¹</text>
          <text class="cost-value">Â¥0.00</text>
        </view>
        <view class="cost-item" wx:if="{{totalDiscount > 0}}">
          <text class="cost-label">ä¼˜æƒ åˆ¸ä¼˜æƒ </text>
          <text class="cost-value discount">-Â¥{{totalDiscount}}</text>
        </view>
        <view class="cost-item total">
          <text class="cost-label">å®ä»˜æ¬¾</text>
          <text class="cost-value">Â¥{{finalTotalPrice}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨é—´è· -->
    <view class="bottom-space"></view>
  </scroll-view>
</view>

<!-- åº•éƒ¨æ“ä½œæ  -->
<view class="checkout-footer" wx:if="{{!loading}}">
  <view class="footer-info">
    <text class="total-label">å®ä»˜æ¬¾:</text>
    <text class="total-price">Â¥{{finalTotalPrice}}</text>
  </view>
  <t-button 
    theme="primary" 
    size="large"
    bind:tap="submitOrder"
    loading="{{submitting}}"
    disabled="{{!canSubmit}}"
    style="flex: 1; margin-left: 24rpx;"
  >
    {{submitting ? 'æäº¤ä¸­...' : 'æäº¤è®¢å•'}}
  </t-button>
</view>

<!-- åœ°å€é€‰æ‹©å¼¹çª— -->
<t-popup 
  visible="{{showAddressPicker}}" 
  bind:visible-change="onAddressPickerChange"
  placement="bottom"
>
  <view class="address-picker">
    <view class="picker-header">
      <text class="picker-title">é€‰æ‹©æ”¶è´§åœ°å€</text>
      <t-icon name="close" size="32rpx" bind:tap="closeAddressPicker" />
    </view>
    <view class="address-list">
      <view 
        class="address-option {{selectedAddressIndex === index ? 'selected' : ''}}"
        wx:for="{{addressList}}" 
        wx:key="id"
        bindtap="selectAddressOption"
        data-index="{{index}}"
      >
        <t-radio checked="{{selectedAddressIndex === index}}" />
        <text class="address-text">{{item.name}}</text>
      </view>
    </view>
    <view class="picker-footer">
      <t-button theme="primary" bind:tap="confirmAddress" style="width: 100%;">
        ç¡®è®¤é€‰æ‹©
      </t-button>
    </view>
  </view>
</t-popup> 