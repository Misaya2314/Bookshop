<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<t-navbar title="å•†å®¶åå°">
  <view slot="right" class="nav-actions">
    <t-icon name="setting" size="40rpx" bind:tap="goToSettings" />
  </view>
</t-navbar>

<!-- åŠ è½½çŠ¶æ€ -->
<t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="åŠ è½½ä¸­..." />

<scroll-view scroll-y class="dashboard-container" wx:else>
  <!-- åº—é“ºæ¦‚è§ˆ -->
  <view class="shop-overview">
    <view class="shop-header">
      <t-avatar size="large" class="shop-avatar" image="{{shopInfo.avatarUrl}}">
        <text slot="content" wx:if="{{!shopInfo.avatarUrl}}">{{shopInfo.name.charAt(0)}}</text>
      </t-avatar>
      <view class="shop-details">
        <text class="shop-name">{{shopInfo.name}}</text>
        <text class="shop-desc">{{shopInfo.description}}</text>
        <view class="shop-status">
          <t-tag theme="{{shopInfo.status === 'active' ? 'success' : 'warning'}}" size="small">
            {{shopInfo.statusText}}
          </t-tag>
        </view>
      </view>
      <t-icon name="chevron-right" size="32rpx" color="#999" />
    </view>
  </view>

  <!-- æ•°æ®ç»Ÿè®¡ -->
  <view class="stats-section">
    <view class="section-title">ç»è¥æ•°æ®</view>
    <view class="stats-grid">
      <view class="stat-item" wx:for="{{stats}}" wx:key="type">
        <text class="stat-value">{{item.value}}</text>
        <text class="stat-label">{{item.label}}</text>
        <text class="stat-unit">{{item.unit}}</text>
      </view>
    </view>
  </view>

  <!-- å¿«æ·æ“ä½œ -->
  <view class="quick-actions">
    <view class="section-title">å¿«æ·æ“ä½œ</view>
    <view class="action-grid">
      <view 
        class="action-item" 
        wx:for="{{quickActions}}" 
        wx:key="id"
        bind:tap="handleQuickAction"
        data-action="{{item.action}}"
      >
        <view class="action-icon" style="background-color: {{item.bgColor}}">
          <t-icon name="{{item.icon}}" size="48rpx" color="white" />
        </view>
        <text class="action-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- å¾…å¤„ç†äº‹é¡¹ -->
  <view class="pending-tasks" wx:if="{{pendingTasks && pendingTasks.length > 0}}">
    <view class="section-title">å¾…å¤„ç†äº‹é¡¹</view>
    <view class="task-list">
      <view 
        class="task-item" 
        wx:for="{{pendingTasks}}" 
        wx:key="id"
        bind:tap="handleTask"
        data-action="{{item.action}}"
      >
        <view class="task-icon {{item.urgent ? 'urgent' : ''}}">
          <t-icon name="{{item.icon}}" size="40rpx" />
        </view>
        <view class="task-content">
          <text class="task-title">{{item.title}}</text>
          <text class="task-desc">{{item.desc}}</text>
        </view>
        <view class="task-badge" wx:if="{{item.count > 0}}">
          <t-tag theme="{{item.urgent ? 'danger' : 'primary'}}" size="small">
          {{item.count}}
        </t-tag>
        </view>
        <t-icon name="chevron-right" size="32rpx" color="#ccc" />
      </view>
    </view>
  </view>

  <!-- æœ€è¿‘è®¢å• -->
  <view class="recent-orders" wx:if="{{recentOrders && recentOrders.length > 0}}">
    <view class="section-header">
      <text class="section-title">æœ€è¿‘è®¢å•</text>
      <t-button size="small" variant="text" bind:tap="goToOrderManagement">æŸ¥çœ‹å…¨éƒ¨</t-button>
    </view>
    <view class="order-list">
      <view class="order-item" wx:for="{{recentOrders}}" wx:key="_id" bindtap="viewOrderDetail" data-id="{{item._id}}">
        <view class="order-header">
          <text class="order-no">{{item.orderNo}}</text>
          <text class="order-status status-{{item.status}}">{{item.statusText}}</text>
        </view>
        <view class="order-content">
          <text class="order-products">{{item.items[0].title}}{{item.items.length > 1 ? ' ç­‰' + item.items.length + 'ä»¶å•†å“' : ''}}</text>
          <text class="order-amount">Â¥{{item.totalPrice}}</text>
        </view>
        <view class="order-footer">
          <text class="order-time">{{item.createTime}}</text>
          <t-button wx:if="{{item.status === 'paid'}}" size="small" theme="primary" bind:tap="shipOrder" data-id="{{item._id}}">
            å‘è´§
          </t-button>
        </view>
      </view>
    </view>
  </view>

  <!-- å•†å“ç®¡ç† -->
  <view class="product-management">
    <view class="section-header">
      <text class="section-title">å•†å“ç®¡ç†</text>
      <view class="section-actions">
        <t-button size="medium" theme="primary" shape="round" bind:tap="addProduct">
          <t-icon name="add" size="32rpx" style="margin-right: 8rpx;" />
          æ·»åŠ å•†å“
        </t-button>
      </view>
    </view>
    
    <view class="product-tabs">
      <view 
        class="tab-item {{currentTab === item.value ? 'active' : ''}}" 
        wx:for="{{productTabs}}" 
        wx:key="value"
        bindtap="switchTab"
        data-tab="{{item.value}}"
      >
        <text class="tab-label">{{item.label}}</text>
        <text class="tab-count">({{item.count}})</text>
      </view>
    </view>

    <view class="product-list" wx:if="{{products.length > 0}}">
      <view class="product-item" wx:for="{{products}}" wx:key="_id">
        <view class="product-image">
          <image wx:if="{{item.images && item.images.length > 0}}" src="{{item.images[0]}}" mode="aspectFill" class="product-img" />
          <text wx:else class="product-icon">{{item.icon}}</text>
        </view>
        <view class="product-info">
          <text class="product-title">{{item.title}}</text>
          <text class="product-author">{{item.author}}</text>
          <view class="product-meta">
          <text class="product-price">Â¥{{item.price}}</text>
            <text class="product-stock stock-{{item.stock <= 5 ? 'low' : 'normal'}}">åº“å­˜: {{item.stock}}</text>
            <text class="product-sales">é”€é‡: {{item.sales}}</text>
          </view>
        </view>
        <view class="product-actions">
          <t-button size="small" variant="outline" bind:tap="editProduct" data-id="{{item._id}}">
            ç¼–è¾‘
          </t-button>
          <t-button size="small" variant="text" bind:tap="toggleProductStatus" data-id="{{item._id}}">
            ç®¡ç†
          </t-button>
        </view>
      </view>
    </view>

    <view class="empty-products" wx:else>
      <view class="empty-icon">ğŸ“š</view>
      <text class="empty-text">æš‚æ— å•†å“</text>
      <text class="empty-desc">å¿«å»æ·»åŠ æ‚¨çš„ç¬¬ä¸€æœ¬ä¹¦å§</text>
      <t-button theme="primary" size="large" bind:tap="addProduct" style="margin-top: 40rpx;">
        æ·»åŠ å•†å“
      </t-button>
    </view>
  </view>
</scroll-view> 

<!-- å•†å“æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
<t-popup visible="{{showProductModal}}" placement="bottom" bind:visible-change="onProductModalChange">
  <view class="product-modal">
    <view class="modal-header">
      <text class="modal-title">{{editingProduct ? 'ç¼–è¾‘å•†å“' : 'æ·»åŠ å•†å“'}}</text>
      <t-icon name="close" size="48rpx" bind:tap="closeProductModal" />
    </view>
    
    <scroll-view scroll-y class="modal-content">
        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
      <view class="image-upload-section">
        <text class="section-label">å•†å“å›¾ç‰‡</text>
        <view class="image-grid">
          <view class="image-item" wx:for="{{productForm.images}}" wx:key="*this">
            <image src="{{item}}" mode="aspectFill" class="uploaded-image" />
            <view class="image-delete" bind:tap="deleteImage" data-index="{{index}}">
              <t-icon name="close" size="24rpx" color="#fff" />
            </view>
          </view>
          <view class="image-upload-btn" bind:tap="uploadImage" wx:if="{{productForm.images.length < 3}}">
            <t-icon name="add" size="48rpx" color="#999" />
            <text class="upload-text">ä¸Šä¼ å›¾ç‰‡</text>
            <text class="upload-tip">æœ€å¤š3å¼ </text>
          </view>
        </view>
      </view>

      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="form-section">
        <text class="section-label">åŸºæœ¬ä¿¡æ¯</text>
        <t-cell-group>
          <t-cell title="ä¹¦å" required>
            <t-input slot="note" placeholder="è¯·è¾“å…¥ä¹¦å" value="{{productForm.title}}" bind:change="onInputChange" data-field="title" />
          </t-cell>
          
          <t-cell title="ä½œè€…" required>
            <t-input slot="note" placeholder="è¯·è¾“å…¥ä½œè€…" value="{{productForm.author}}" bind:change="onInputChange" data-field="author" />
          </t-cell>
          
          <t-cell title="ç°ä»·" required>
            <t-input slot="note" placeholder="è¯·è¾“å…¥ç°ä»·" value="{{productForm.price}}" type="digit" bind:change="onInputChange" data-field="price" />
          </t-cell>
          
          <t-cell title="åŸä»·">
            <t-input slot="note" placeholder="è¯·è¾“å…¥åŸä»·" value="{{productForm.originalPrice}}" type="digit" bind:change="onInputChange" data-field="originalPrice" />
          </t-cell>
          
          <t-cell title="åº“å­˜" required>
            <t-input slot="note" placeholder="è¯·è¾“å…¥åº“å­˜æ•°é‡" value="{{productForm.stock}}" type="number" bind:change="onInputChange" data-field="stock" />
          </t-cell>
        </t-cell-group>
      </view>

      <!-- åˆ†ç±»ä¿¡æ¯ -->
      <view class="form-section">
        <text class="section-label">åˆ†ç±»ä¿¡æ¯</text>
        <t-cell-group>
          <t-cell title="åˆ†ç±»" arrow>
            <picker slot="note" mode="selector" range="{{categoryOptions}}" range-key="name" value="{{productForm.categoryIndex}}" bind:change="onCategoryChange">
              <text>{{productForm.categoryName}}</text>
            </picker>
          </t-cell>
          
          <t-cell title="å­åˆ†ç±»" arrow>
            <picker slot="note" mode="selector" range="{{subCategoryOptions}}" range-key="name" value="{{productForm.subCategoryIndex}}" bind:change="onSubCategoryChange">
              <text>{{productForm.subCategoryName}}</text>
            </picker>
          </t-cell>
          
          <t-cell title="å“ç›¸" arrow>
            <picker slot="note" mode="selector" range="{{conditionOptions}}" value="{{productForm.conditionIndex}}" bind:change="onConditionChange">
              <text>{{productForm.condition}}</text>
            </picker>
          </t-cell>
        </t-cell-group>
      </view>

      <!-- è¯¦ç»†ä¿¡æ¯ -->
      <view class="form-section">
        <text class="section-label">è¯¦ç»†ä¿¡æ¯</text>
        <t-cell-group>
          <t-cell title="å‡ºç‰ˆç¤¾">
            <t-input slot="note" placeholder="è¯·è¾“å…¥å‡ºç‰ˆç¤¾" value="{{productForm.publisher}}" bind:change="onInputChange" data-field="publisher" />
          </t-cell>
          
          <t-cell title="ISBN">
            <t-input slot="note" placeholder="è¯·è¾“å…¥ISBN" value="{{productForm.isbn}}" bind:change="onInputChange" data-field="isbn" />
          </t-cell>
          
          <t-cell title="å›¾æ ‡">
            <t-input slot="note" placeholder="è¯·è¾“å…¥emojiå›¾æ ‡" value="{{productForm.icon}}" bind:change="onInputChange" data-field="icon" />
          </t-cell>
        </t-cell-group>
        
        <!-- æè¿°å­—æ®µå•ç‹¬å¤„ç† -->
        <view class="description-field">
          <text class="field-label">å›¾ä¹¦æè¿°</text>
          <textarea 
            class="description-textarea"
            placeholder="è¯·è¾“å…¥å›¾ä¹¦æè¿°"
            value="{{productForm.description}}"
            bind:input="onDescriptionChange"
          maxlength="500"
            show-confirm-bar="{{false}}"
        />
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <t-button variant="outline" bind:tap="closeProductModal" style="margin-right: 20rpx;">å–æ¶ˆ</t-button>
      <t-button theme="primary" bind:tap="saveProduct" loading="{{saving}}" style="flex: 1;">
        {{editingProduct ? 'ä¿å­˜' : 'æ·»åŠ '}}
      </t-button>
    </view>
  </view>
</t-popup> 