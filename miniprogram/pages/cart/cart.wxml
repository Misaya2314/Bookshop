<!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
<t-navbar title="è´­ç‰©è½¦">
  <view slot="right" class="edit-btn" bindtap="toggleEdit" wx:if="{{isLoggedIn}}">
    <text>{{isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
  </view>
</t-navbar>

<view class="cart-container">
  <!-- æœªç™»å½•å¼•å¯¼ç•Œé¢ -->
  <view class="login-guide" wx:if="{{!isLoggedIn}}">
    <view class="guide-content">
      <view class="guide-icon">ğŸ›’</view>
      <text class="guide-title">è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</text>
      <text class="guide-desc">ç™»å½•åæŸ¥çœ‹æ‚¨æ·»åŠ çš„å•†å“</text>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="goToLogin"
        class="login-btn"
      >
        ç«‹å³ç™»å½•
      </t-button>
      <view class="browse-tip">
        <text>æ‚¨ä¹Ÿå¯ä»¥ç»§ç»­æµè§ˆå•†å“</text>
        <text class="browse-link" bindtap="goToBrowse"> å»é€›é€› â†’</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading && isLoggedIn}}">
    <t-loading theme="spinner" size="40rpx" />
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
  <scroll-view scroll-y class="cart-content" wx:if="{{!loading && isLoggedIn && cartItems.length > 0}}">
    <!-- å•†å®¶åˆ†ç»„ -->
    <view 
      class="merchant-group" 
      wx:for="{{merchants}}" 
      wx:key="id"
      wx:for-item="merchant"
    >
      <!-- å•†å®¶å¤´éƒ¨ -->
      <view class="merchant-header">
        <t-checkbox 
          checked="{{merchant.checked}}" 
          bind:change="onMerchantCheck"
          data-id="{{merchant.id}}"
        />
        <t-avatar size="small" style="margin: 0 24rpx;">
          <text slot="content">{{merchant.name.charAt(0)}}</text>
        </t-avatar>
        <text class="merchant-name">{{merchant.name}}</text>
      </view>

      <!-- å•†å“åˆ—è¡¨ -->
      <view class="cart-items">
        <view 
          class="cart-item" 
          wx:for="{{merchant.items}}" 
          wx:key="id"
          wx:for-item="cartItem"
        >
          <t-checkbox 
            checked="{{cartItem.checked}}" 
            bind:change="onItemCheck"
            data-merchant-id="{{merchant.id}}"
            data-item-id="{{cartItem.id}}"
          />
          <view class="item-image">
            <t-image 
              wx:if="{{cartItem.images && cartItem.images.length > 0 && cartItem.images[0].length > 2}}"
              src="{{cartItem.images[0]}}" 
              mode="aspectFill"
              width="120rpx"
              height="120rpx"
              loading="lazy"
              error-icon="book"
            />
            <text wx:else class="book-emoji">{{cartItem.images && cartItem.images[0] ? cartItem.images[0] : 'ğŸ“š'}}</text>
          </view>
          <view class="item-info">
            <text class="item-title">{{cartItem.title}}</text>
            <view class="item-footer">
              <text class="item-price">Â¥{{cartItem.price}}</text>
              <view class="item-actions">
                <t-stepper 
                  value="{{cartItem.quantity}}" 
                  bind:change="onQuantityChange"
                  data-merchant-id="{{merchant.id}}"
                  data-item-id="{{cartItem.id}}"
                  min="{{1}}"
                  max="{{cartItem.stock}}"
                  size="small"
                />
                <t-button 
                  size="extra-small" 
                  variant="text" 
                  theme="danger"
                  bind:tap="removeItem"
                  data-merchant-id="{{merchant.id}}"
                  data-item-id="{{cartItem.id}}"
                  style="margin-left: 16rpx;"
                >
                  åˆ é™¤
                </t-button>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>


  </scroll-view>

  <!-- ç©ºè´­ç‰©è½¦çŠ¶æ€ï¼ˆå·²ç™»å½•ä½†æ— å•†å“ï¼‰ -->
  <view class="empty-cart" wx:if="{{!loading && isLoggedIn && cartItems.length === 0}}">
    <view class="empty-content">
      <view class="empty-icon">ğŸ“š</view>
      <text class="empty-title">è´­ç‰©è½¦æ˜¯ç©ºçš„</text>
      <text class="empty-desc">å¿«å»æŒ‘é€‰å¿ƒä»ªçš„å•†å“å§</text>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="goToBrowse"
        class="browse-btn"
      >
        å»é€›é€›
      </t-button>
    </view>
  </view>
</view>

<!-- åº•éƒ¨æ“ä½œæ  -->
<view class="cart-actions" wx:if="{{!loading && isLoggedIn && cartItems.length > 0}}">
  <view class="footer-content">
    <view class="footer-left">
      <t-checkbox 
        checked="{{allChecked}}" 
        bind:change="onSelectAll"
      />
      <text class="select-all-text">å…¨é€‰</text>
    </view>
    <view class="footer-right">
      <view class="total-info">
        <text class="total-label">åˆè®¡:</text>
        <text class="total-price">Â¥{{totalPrice}}</text>
      </view>
    </view>
  </view>
  <view class="footer-actions">
    <t-button 
      wx:if="{{isEditing}}"
      variant="outline"
      bind:tap="moveToFavorites"
      disabled="{{checkedCount === 0}}"
    >
      ç§»å…¥æ”¶è— ({{checkedCount}})
    </t-button>
    <t-button 
      theme="primary" 
      bind:tap="{{isEditing ? 'deleteSelected' : 'checkout'}}"
      disabled="{{checkedCount === 0}}"
      style="flex: 1; margin-left: {{isEditing ? '24rpx' : '0'}};"
    >
      {{isEditing ? 'åˆ é™¤' : 'ç»“ç®—'}} ({{checkedCount}})
    </t-button>
  </view>
</view> 