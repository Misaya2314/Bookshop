<!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
<t-navbar title="è´­ç‰©è½¦">
  <view slot="right" class="edit-btn" bindtap="toggleEdit">
    <text>{{isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
  </view>
</t-navbar>

<view class="cart-container">
  <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
  <scroll-view scroll-y class="cart-content" wx:if="{{cartItems.length > 0}}">
    <!-- å•†å®¶åˆ†ç»„ -->
    <view 
      class="merchant-group" 
      wx:for="{{merchants}}" 
      wx:key="id"
      wx:for-item="merchant"
    >
      <!-- å•†å®¶å¤´éƒ¨ -->
      <view class="merchant-header">
        <t-checkbox 
          value="{{merchant.checked}}" 
          bind:change="onMerchantCheck"
          data-id="{{merchant.id}}"
        />
        <t-avatar size="small" style="margin: 0 24rpx;">
          <text slot="content">{{merchant.name.charAt(0)}}</text>
        </t-avatar>
        <text class="merchant-name">{{merchant.name}}</text>
      </view>

      <!-- å•†å“åˆ—è¡¨ -->
      <view class="cart-items">
        <view 
          class="cart-item" 
          wx:for="{{merchant.items}}" 
          wx:key="_id"
          wx:for-item="item"
        >
          <t-checkbox 
            value="{{item.checked}}" 
            bind:change="onItemCheck"
            data-merchant-id="{{merchant.id}}"
            data-item-id="{{item._id}}"
          />
          <view class="item-image">
            <text class="book-emoji">{{item.icon}}</text>
          </view>
          <view class="item-info">
            <text class="item-title">{{item.title}}</text>
            <text class="item-desc">{{item.description}}</text>
            <view class="item-footer">
              <text class="item-price">Â¥{{item.price}}</text>
              <t-stepper 
                value="{{item.quantity}}" 
                bind:change="onQuantityChange"
                data-merchant-id="{{merchant.id}}"
                data-item-id="{{item._id}}"
                min="{{1}}"
                max="{{item.stock}}"
                size="small"
              />
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ¨èå•†å“ -->
    <view class="recommend-section">
      <view class="section-header">
        <text class="section-title">ä¸ºä½ æ¨è</text>
      </view>
      <view class="recommend-grid">
        <view 
          class="recommend-item" 
          wx:for="{{recommendItems}}" 
          wx:key="id"
          bindtap="goToDetail"
          data-id="{{item.id}}"
        >
          <view class="recommend-image">
            <text class="book-emoji">{{item.icon}}</text>
          </view>
          <text class="recommend-title">{{item.title}}</text>
          <text class="recommend-price">Â¥{{item.price}}</text>
          <t-button 
            size="small" 
            variant="outline" 
            bind:tap="addToCart"
            data-id="{{item.id}}"
            catch:tap="true"
          >
            åŠ å…¥è´­ç‰©è½¦
          </t-button>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- ç©ºè´­ç‰©è½¦çŠ¶æ€ -->
  <view class="empty-cart" wx:else>
    <view class="empty-icon">ğŸ›’</view>
    <text class="empty-text">è´­ç‰©è½¦æ˜¯ç©ºçš„</text>
    <text class="empty-desc">å¿«å»æŒ‘é€‰å¿ƒä»ªçš„ä¹¦ç±å§</text>
    <t-button 
      theme="primary" 
      size="large" 
      bind:tap="goShopping"
      style="margin-top: 40rpx; width: 400rpx;"
    >
      å»é€›é€›
    </t-button>
  </view>
</view>

<!-- åº•éƒ¨ç»“ç®—æ  -->
<view class="cart-footer" wx:if="{{cartItems.length > 0}}">
  <view class="footer-content">
    <view class="footer-left">
      <t-checkbox 
        value="{{allChecked}}" 
        bind:change="onSelectAll"
      />
      <text class="select-all-text">å…¨é€‰</text>
    </view>
    <view class="footer-right">
      <view class="total-info">
        <text class="total-label">åˆè®¡:</text>
        <text class="total-price">Â¥{{totalPrice}}</text>
      </view>
    </view>
  </view>
  <view class="footer-actions">
    <t-button 
      wx:if="{{isEditing}}"
      variant="outline"
      bind:tap="moveToFavorites"
      disabled="{{checkedCount === 0}}"
    >
      ç§»å…¥æ”¶è— ({{checkedCount}})
    </t-button>
    <t-button 
      theme="primary" 
      bind:tap="{{isEditing ? 'deleteSelected' : 'checkout'}}"
      disabled="{{checkedCount === 0}}"
      style="flex: 1; margin-left: {{isEditing ? '24rpx' : '0'}};"
    >
      {{isEditing ? 'åˆ é™¤' : 'ç»“ç®—'}} ({{checkedCount}})
    </t-button>
  </view>
</view> 