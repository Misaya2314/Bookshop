<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<t-navbar title="å•†å“è¯¦æƒ…">
  <view slot="right" class="nav-actions">
    <t-icon name="share" size="40rpx" bind:tap="onShare" />
    <t-icon name="more" size="40rpx" bind:tap="showMore" style="margin-left: 24rpx;" />
  </view>
</t-navbar>

<scroll-view scroll-y class="detail-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å•†å“è¯¦æƒ…å†…å®¹ -->
  <view wx:if="{{product && !loading}}">
  <!-- å•†å“å›¾ç‰‡è½®æ’­ -->
  <view class="product-images">
      <!-- å¦‚æœæœ‰çœŸå®å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡è½®æ’­ -->
      <block wx:if="{{product.images && product.images.length > 0 && product.images[0] !== 'ğŸ“–' && product.images[0] !== 'ğŸ“š'}}">
        <swiper 
          class="image-swiper"
      autoplay="{{false}}"
      indicator-dots="{{true}}"
          indicator-color="rgba(255,255,255,0.5)"
          indicator-active-color="#fff"
          circular="{{true}}"
      current="{{currentImageIndex}}"
          bindchange="onImageChange"
    >
          <swiper-item wx:for="{{product.images}}" wx:key="*this" wx:for-index="imgIndex">
            <image 
              src="{{item}}" 
              mode="aspectFit"
              class="product-image"
              data-index="{{imgIndex}}"
              bindload="onImageLoad"
              binderror="onImageError"
            />
          </swiper-item>
        </swiper>
        <view class="image-indicator">{{currentImageIndex + 1}}/{{product.images.length}}</view>
      </block>
      
      <!-- å¦‚æœæ²¡æœ‰å›¾ç‰‡æˆ–è€…æ˜¯emojiï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡ -->
      <block wx:else>
        <view class="default-image">
          <text class="product-emoji">{{product.images && product.images[0] ? product.images[0] : 'ğŸ“š'}}</text>
        </view>
      </block>
  </view>

  <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
  <view class="product-info">
    <view class="price-section">
      <text class="current-price">Â¥{{product.price}}</text>
      <view class="original-price" wx:if="{{product.originalPrice && product.originalPrice > product.price}}">
        <text class="original-text">åŸä»·: Â¥{{product.originalPrice}}</text>
        <t-tag theme="danger" size="small">{{product.discount}}æŠ˜</t-tag>
      </view>
    </view>
    <text class="product-title">{{product.title}}</text>
    <text class="product-subtitle">{{product.subtitle}}</text>
    <view class="product-stats">
      <view class="stat-item">
        <t-icon name="star-filled" size="28rpx" color="#fbbf24" />
        <text>{{product.rating}}åˆ†</text>
      </view>
      <view class="stat-item">
        <text>å·²å”®{{product.sales}}æœ¬</text>
      </view>
      <view class="stat-item">
        <text>åº“å­˜: {{product.stock}}æœ¬</text>
      </view>
    </view>
  </view>

  <!-- å•†å“å‚æ•° -->
  <view class="product-params">
    <view class="section-title">å•†å“ä¿¡æ¯</view>
    <t-cell-group>
      <t-cell 
        wx:for="{{product.params}}" 
        wx:key="label"
        title="{{item.label}}" 
        note="{{item.value}}"
        border="{{false}}"
      />
    </t-cell-group>
  </view>

  <!-- å–å®¶ä¿¡æ¯ -->
  <view class="seller-info">
    <view class="section-title">å–å®¶ä¿¡æ¯</view>
    <view class="seller-card" bindtap="goToSellerProfile">
      <t-avatar size="large">
        <text slot="content">{{product.seller.name.charAt(0)}}</text>
      </t-avatar>
      <view class="seller-details">
        <text class="seller-name">{{product.seller.name}}</text>
        <text class="seller-desc">{{product.seller.college}} Â· {{product.seller.grade}}</text>
        <view class="seller-stats">
          <text class="seller-rating">â­ {{product.seller.rating}}åˆ†</text>
          <text class="seller-sales">å·²å”®{{product.seller.totalSales}}æœ¬</text>
        </view>
      </view>
      <t-icon name="chevron-right" size="32rpx" color="#999" />
    </view>
  </view>

  <!-- é…é€ä¿¡æ¯ -->
  <view class="delivery-info">
    <view class="section-title">é…é€ä¿¡æ¯</view>
    <t-cell-group>
      <t-cell title="é…é€æ–¹å¼" note="æ ¡å†…é…é€ï¼Œé¢„è®¡1-2å¤©é€è¾¾" leftIcon="delivery" />
      <t-cell title="é…é€åœ°å€" note="{{selectedAddress || 'ç‚¹å‡»é€‰æ‹©é…é€åœ°å€'}}" leftIcon="location" arrow bind:click="selectAddress" />
      <t-cell title="è¿è´¹" note="å…è¿è´¹" leftIcon="discount" />
    </t-cell-group>
  </view>

  <!-- å•†å“è¯¦æƒ… -->
  <view class="product-description">
    <view class="section-title">å•†å“è¯¦æƒ…</view>
    <view class="description-content">
      <text class="description-text">{{product.description}}</text>
    </view>
  </view>

  <!-- è¯„ä»·åŒºåŸŸ -->
  <view class="reviews-section">
    <view class="section-header">
      <text class="section-title">ä¹°å®¶è¯„ä»·</text>
      <view class="view-all" bindtap="goToAllReviews">
        <text>æŸ¥çœ‹å…¨éƒ¨</text>
        <t-icon name="chevron-right" size="28rpx" />
      </view>
    </view>
    <view class="review-item" wx:for="{{product.reviews}}" wx:key="_id">
      <view class="review-header">
        <t-avatar size="small">
          <text slot="content">{{item.userName.charAt(0)}}</text>
        </t-avatar>
        <view class="review-user">
          <text class="user-name">{{item.userName}}</text>
          <text class="review-time">{{item.time}}</text>
        </view>
        <view class="review-rating">
          <block wx:for="{{5}}" wx:key="*this" wx:for-index="star">
            <t-icon 
              name="star-filled" 
              size="24rpx" 
              color="{{star < item.rating ? '#fbbf24' : '#e5e7eb'}}" 
            />
          </block>
        </view>
      </view>
      <text class="review-content">{{item.content}}</text>
    </view>
  </view>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:if="{{!loading && !product}}">
    <text>å•†å“ä¿¡æ¯åŠ è½½å¤±è´¥</text>
    <button bindtap="retry">é‡è¯•</button>
  </view>
</scroll-view>

<!-- åº•éƒ¨æ“ä½œæ  -->
<view class="product-actions">
  <view class="action-buttons">
    <view class="action-icons">
      <view class="action-icon" bindtap="toggleFavorite">
        <t-icon name="{{product.isFavorite ? 'heart-filled' : 'heart'}}" size="48rpx" color="{{product.isFavorite ? '#ff4757' : '#999'}}" />
        <text class="icon-label">{{product.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </view>
      <view class="action-icon" bindtap="contactSeller">
        <t-icon name="chat" size="48rpx" color="#999" />
        <text class="icon-label">å®¢æœ</text>
      </view>
    </view>
    <view class="purchase-buttons">
      <t-button theme="warning" bind:tap="addToCart" style="flex: 1; margin-right: 24rpx;">
        åŠ å…¥è´­ç‰©è½¦
      </t-button>
      <t-button theme="primary" bind:tap="buyNow" style="flex: 1;">
        ç«‹å³è´­ä¹°
      </t-button>
    </view>
  </view>
</view> 